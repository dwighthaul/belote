<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Belote backend</title>
	</head>
	<body>
		<a href="/">Frontend</a>
		<br /><br />
		<button id="load_fixtures" type="button">Load users</button>
		<br /><br />
		<button id="clear_tables" type="button">Clear Tables</button>
		<br /><br />
		<button id="storage_delete" type="button">Delete storage</button>
		<br /><br />
		<button id="generate_tables" type="button">Distribute Tables</button>
		<br /><br />
		<button id="notify_all" type="button">Notify all</button>
		<br /><br />
		<ul id="tables"></ul>
		<div id="messages">disconnected</div>
		<script>
			// @ts-check
			const connectWebsocket = () => {
				let hostname = window.location.host;
				const scheme = document.location.protocol === 'http:' ? 'ws://' : 'wss://';
				let ws = new WebSocket(scheme + hostname + '/admin/meltdown');
				const messagesDiv = document.getElementById('messages');
				if (!messagesDiv) {
					console.log('messages element not found');
					return;
				}

				ws.onopen = () => {
					const msg = 'Connected to Meltdown, tables updated';
					messagesDiv.innerHTML = msg;
					console.log(msg);
					refreshTables();
				};

				ws.onmessage = (event) => {
					const msg = `Update tables because : ${event.data}`;
					console.log(msg);
					messagesDiv.innerHTML = msg;
					refreshTables();
				};

				ws.onclose = () => {
					const msg = 'Disconnected from Meltdown!';
					console.log(msg);
					messagesDiv.innerHTML = msg;
					const ulTables = document.getElementById('tables');
					if (!ulTables) {
						console.log('tables element not found');
						return;
					}
					ulTables.innerHTML = '';
				};
			};

			const refreshTables = () =>
				fetch('/public/tables')
					.then((resp) => resp.text())
					.then((text) => {
						const ulTables = document.getElementById('tables');
						if (!ulTables) {
							console.log('tables element not found');
							return;
						}
						ulTables.innerHTML = '';

						const tables = JSON.parse(text);
						console.log('Tables:', tables);
						for (const [table, users] of Object.entries(tables)) {
							let liTable = document.createElement('li');
							let ulUsers = document.createElement('ul');
							console.log('Table:', table);

							let sortedUsers = users.sort((a, b) => {
								return a.name < b.name;
							});

							for (const user of sortedUsers) {
								console.log('User:', user);
								let liUser = document.createElement('li');
								let deleteButton = document.createElement('button');
								deleteButton.innerText = 'Delete';
								deleteButton.addEventListener('click', function (event) {
									fetch('/admin/users/delete?username=' + encodeURIComponent(user.name)).then(() => {
										console.log('Delete user:', user.name);
										// refreshTables();
									});
								});
								liUser.appendChild(deleteButton);

								let finishButton = document.createElement('button');
								finishButton.innerText = 'Finish';
								finishButton.addEventListener('click', function (event) {
									fetch('/admin/users/finish?username=' + encodeURIComponent(user.name)).then(() => {
										console.log('Finished user:', user.name);
										// refreshTables();
									});
								});
								liUser.appendChild(finishButton);

								let spanInfo = document.createElement('span');
								spanInfo.innerText =
									` ${user.name}` +
									` [IP: ${user.ip}]` +
									` [Joined: ${new Date(user.joinedAt).toLocaleString()}]` +
									` [Activity: ${new Date(user.lastActiveAt).toLocaleString()}]`;
								liUser.appendChild(spanInfo);

								ulUsers.appendChild(liUser);
							}
							liTable.innerText = table + ' (' + users.length + ' players)';
							liTable.appendChild(ulUsers);
							ulTables.appendChild(liTable);
						}
					});

			(function () {
				connectWebsocket();

				const loadFixturesButton = document.getElementById('load_fixtures');
				if (!loadFixturesButton) {
					console.log('load fixtures button not found');
					return;
				}
				loadFixturesButton.addEventListener('click', function (event) {
					fetch('/admin/users/fixtures')
						.then((resp) => resp.text())
						.then((text) => {
							console.log(text);
							refreshTables();
						});
				});

				const clearTablesButton = document.getElementById('clear_tables');
				if (!clearTablesButton) {
					console.log('clear tables button not found');
					return;
				}
				clearTablesButton.addEventListener('click', function (event) {
					fetch('/admin/tables/clear')
						.then((resp) => resp.text())
						.then((text) => {
							console.log(text);
						});
				});

				const generateTablesButton = document.getElementById('generate_tables');
				if (!generateTablesButton) {
					console.log('generate tables button not found');
					return;
				}
				generateTablesButton.addEventListener('click', function (event) {
					fetch('/admin/tables/generate')
						.then((resp) => resp.text())
						.then((text) => {
							console.log(text);
						});
				});

				const deleteStorageButton = document.getElementById('storage_delete');
				if (!deleteStorageButton) {
					console.log('delete storage button not found');
					return;
				}
				deleteStorageButton.addEventListener('click', function (event) {
					fetch('/admin/storage/delete')
						.then((resp) => resp.text())
						.then((text) => {
							console.log(text);
						});
				});

				const notifyAllButton = document.getElementById('notify_all');
				if (!notifyAllButton) {
					console.log('notify all button not found');
					return;
				}
				notifyAllButton.addEventListener('click', function (event) {
					fetch('/admin/notify')
						.then((resp) => resp.text())
						.then((text) => {
							console.log(text);
						});
				});
			})();
		</script>
	</body>
</html>
