<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Meltdown Belote</title>
		<link rel="icon" type="image/png" href="/favicon.png" />
		<link rel="stylesheet" href="/styles.css" />
		<meta name="description" content="Meltdown Belote - Gestion des tables de belote" />
		<script type="text/typescript" src="./src/utils.ts"></script>

	</head>
	<body>
		<form id="join">
			<label for="username">Adepte:</label>
			<input type="text" name="username" placeholder="Ton ostie de pseudo" id="username" required />
			<button id="join_button" type="submit">Je rejoins la secte</button>
		</form>
		<div id="connected"></div>
		<br />


		<div id="tables" class=""></div>
		
		<div id="messages">disconnected</div>
		<a href="/help">Aide</a>
		<br />
		<a href="/valeurs.webp" target="_blank">Valeur des cartes</a>
		<br />
		<a href="/help">Aide</a><br />
		<a href="/valeurs.webp">Valeur des cartes</a><br />
		<a href="/backend">Backend</a>
		<script>

			// @ts-check
			(function () {
				const messagesDiv = document.getElementById('messages');
				if (!messagesDiv) {
					console.error('messages element not found');
					return;
				}

				const ulTables = document.getElementById('tables');

				if (!ulTables) {
					console.error('tables element not found');
					return;
				}

				const joinButton = document.getElementById('join_button');
				if (!joinButton) {
					console.error('join_button button not found');
					return;
				}
				const joinButtonInput = /** @type {HTMLInputElement} */ (joinButton);

				const connectedDiv = document.getElementById('connected');
				if (!connectedDiv) {
					console.error('connected element not found');
					return;
				}

				const usernameElem = document.getElementById('username');
				if (!usernameElem) {
					console.error('username element not found');
					return;
				}
				const usernameInput = /** @type {HTMLInputElement} */ (usernameElem);
				var hr = document.createElement('hr');
				hr.className = 'table_separator';
				ulTables.appendChild(hr);

				const connectWebsocket = (username) => {
					const hostname = window.location.host;
					const scheme = document.location.protocol === 'http:' ? 'ws://' : 'wss://';
					const connect = () => {
						const ws = new WebSocket(scheme + hostname + '/me/meltdown?username=' + encodeURIComponent(username));

						ws.onopen = () => {
							const msg = 'Connected to Meltdown, tables updated';
							messagesDiv.innerHTML = msg;
							console.log(msg);
							refreshTables();
						};

						ws.onmessage = (event) => {
							const msg = `Update tables because : ${event.data}`;
							console.log(msg);
							messagesDiv.innerHTML = msg;
							refreshTables();
						};

						ws.onerror = () => {
							ws.close();
						};

						ws.onclose = () => {
							const msg = 'Disconnected from Meltdown!';
							console.warn(msg);
							messagesDiv.innerHTML = msg;
							ulTables.innerHTML = '';
							setTimeout(connect, 1000);
						};
					};

					connect();
				};

				const refreshTables = () =>
					fetch('/public/tables')
						.then((resp) => resp.text())
						.then((text) => {
							const localUsername = localStorage.getItem('username');
							let found = false;
							ulTables.innerHTML = '';

							const tables = JSON.parse(text);

							var profils = ['nina', 'julien']
							var i = 0;
							for (const [table, users] of Object.entries(tables)) {

								const usersList = Object.entries(users).map(([username, user]) => ({
									name: user.name,
									ready: user.ready,
									ip: user.ip
								}));

								const tableElement = document.createElement('table');
								tableElement.className = 'tables';

								//tableElement.classList.add('background_' + profils[i++ % profils.length]);

								let header = tableElement.createTHead()
								let headerRow = header.insertRow();

				                headerRow.insertCell().appendChild(document.createTextNode('Username'));

				                headerRow.insertCell().appendChild(document.createTextNode('IP'));

				                headerRow.insertCell().appendChild(document.createTextNode('Ready'));

								let readyUsers = 0;
								let tbody = tableElement.createTBody();
								for (const user of usersList) {
									let rowUser = tbody.insertRow();
									const tdUsername = rowUser.insertCell();
									tdUsername.appendChild(document.createTextNode(user.name + (user.name == localUsername ? ' (you)' : '')));

									(user.name == localUsername) ? tdUsername.className = 'username_cell' : null;

									if (user.ready) readyUsers++;

									const tdIp = rowUser.insertCell();

									if (!user.ip) {
										tdIp.appendChild(document.createTextNode('added by admin'));
									}

									if (user.name == localUsername) {
										found = true;
									}

									const tReady = rowUser.insertCell();
									rowUser.classList.add( user.ready ? 'user_ready' : 'user_not_ready');
									tReady.appendChild(document.createTextNode(user.ready ? '✅' : '❌'));

								}

								const tableReady = document.createElement('div');
								tableReady.className = 'table_ready_status';
								tableReady.innerText = table + ' : (' + readyUsers + ' / ' + users.length + ' ready)';
								if (users.length >= 5) {
									tableReady.innerText += ' : apprenez le Tarot a 5 :p';
								}

								ulTables.appendChild(tableReady);
								ulTables.appendChild(tableElement);
								ulTables.appendChild(hr);
							}

							console.log('Found user in tables:', found);

							if (!found) {
								const joinButton = document.getElementById('join_button');
								if (!joinButton) {
									console.error('join_button button not found');
									return;
								}
								const joinButtonInput = /** @type {HTMLInputElement} */ (joinButton);
								joinButtonInput.disabled = false;
								connectedDiv.innerHTML = '';
								localStorage.removeItem('username');

								const connectedDiv = document.getElementById('connected');
								if (!connectedDiv) {
									console.log('connected element not found');
									return;
								}
								connectedDiv.className = 'connectedDiv';
								connectedDiv.innerHTML = '';
							}
						});

				const connectedUser = (username) => {
		
					const joinButton = document.getElementById('join_button');
					if (!joinButton) {
						console.log('join_button button not found');
						return;
					}
					const joinButtonInput = /** @type {HTMLInputElement} */ (joinButton);
					joinButtonInput.disabled = true;

					const joinInputUsernameElement = document.getElementById('username');
					const joinInputUsername = /** @type {HTMLInputElement} */ (joinInputUsernameElement);
					joinInputUsername.disabled = true;

					const connectedDiv = document.getElementById('connected');
					if (!connectedDiv) {
						console.log('connected element not found');
						return;
					}
					connectedDiv.innerHTML = '';
					createButtons(document, username, connectedDiv, joinButtonInput, joinInputUsernameElement);


				};

				const username = localStorage.getItem('username');
				if (username) {
					console.log(`user already set: ${username}`);
					usernameInput.value = username;
					connectedUser(username);
					connectWebsocket(username);
				}

				const joinForm = document.getElementById('join');
				if (!joinForm) {
					console.error('join element not found');
					return;
				}
				joinForm.addEventListener('submit', function (event) {
					event.preventDefault();
					const username = usernameInput.value;

					fetch('/me/join?username=' + encodeURIComponent(username))
						.then((resp) => resp.text())
						.then((text) => {
							localStorage.setItem('username', username);
							connectedUser(username);
							refreshTables();
						});
				});

				refreshTables();

			function createButtons(document, username, connectedDiv, joinButtonInput, joinInputUsername) {


					const quitButton = document.createElement('button');
					quitButton.innerHTML = 'Quit Meltdown (' + username + ')';
					quitButton.addEventListener('click', function (event) {
						fetch('/me/quit?username=' + encodeURIComponent(username)).then(() => {
							console.log('User left:', username);
							localStorage.removeItem('username');
							connectedDiv.innerHTML = '';
							joinButtonInput.disabled = false;
							joinInputUsername.disabled = false;
							refreshTables();
						});
					});
					connectedDiv.appendChild(quitButton);
					connectedDiv.appendChild(document.createElement('br'));

					const finishedButton = document.createElement('button');
					finishedButton.innerHTML = 'Game finished (return to Panama)!';
					finishedButton.addEventListener('click', function (event) {
						fetch('/me/finish?username=' + encodeURIComponent(username)).then((response) => {
							if (response.status == 404) {
								localStorage.removeItem('username');
								connectedDiv.innerHTML = '';
								joinButtonInput.disabled = false;
							} else {
								console.log('User finished:', username);
							}
							refreshTables();
						});
					});
					connectedDiv.appendChild(finishedButton);
					connectedDiv.appendChild(document.createElement('br'));

					const readyButton = document.createElement('button');
					readyButton.innerHTML = 'Ready to play!';
					readyButton.addEventListener('click', function (event) {
						fetch('/me/ready?username=' + encodeURIComponent(username)).then((response) => {
							if (response.status == 404) {
								localStorage.removeItem('username');
								connectedDiv.innerHTML = '';
								joinButtonInput.disabled = false;
							} else {
								console.log('User ready:', username);
								refreshTables();
							}
						});
					});
					connectedDiv.appendChild(readyButton);
			}

			})();




		</script>
	</body>
</html>
