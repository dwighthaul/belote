<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://cdn.jsdelivr.net/npm/htmx.org@4.0.0-alpha1/dist/htmx.min.js"></script>
		<title>Meltdown</title>
	</head>
	<body>
		<form id="join">
			<label for="username">Adepte:</label>
			<input type="text" name="username" placeholder="Ton ostie de pseudo" id="username" required />
			<button id="join_button" type="submit">Je rejoins la secte</button>
		</form>
		<div id="connected"></div>
		<br />

		<ul id="tables"></ul>
		<div id="messages">disconnected</div>
		<script>
			// @ts-check
			const connectWebsocket = (username) => {
				let hostname = window.location.host;
				const scheme = document.location.protocol === 'http:' ? 'ws://' : 'wss://';
				let ws = new WebSocket(scheme + hostname + '/me/meltdown?username=' + encodeURIComponent(username));
				const messagesDiv = document.getElementById('messages');
				if (!messagesDiv) {
					console.log('messages element not found');
					return;
				}

				ws.onopen = () => {
					const msg = 'Connected to Meltdown, tables updated';
					messagesDiv.innerHTML = msg;
					console.log(msg);
					refreshTables();
				};

				ws.onmessage = (event) => {
					const msg = `Update tables because : ${event.data}`;
					console.log(msg);
					messagesDiv.innerHTML = msg;
					refreshTables();
				};

				ws.onclose = () => {
					const msg = 'Disconnected from Meltdown!';
					console.log(msg);
					messagesDiv.innerHTML = msg;
					const ulTables = document.getElementById('tables');
					if (!ulTables) {
						console.log('tables element not found');
						return;
					}
					ulTables.innerHTML = '';
				};
			};

			const refreshTables = () =>
				fetch('/public/tables')
					.then((resp) => resp.text())
					.then((text) => {
						const username = localStorage.getItem('username');
						let found = false;

						const ulTables = document.getElementById('tables');
						if (!ulTables) {
							console.log('tables element not found');
							return;
						}
						ulTables.innerHTML = '';

						const tables = JSON.parse(text);
						console.log('Tables:', tables);

						for (const [table, users] of Object.entries(tables)) {
							let liTable = document.createElement('li');
							let ulUsers = document.createElement('ul');
							for (const [username, user] of Object.entries(users)) {
								let liUser = document.createElement('li');
								liUser.innerText = user.name;
								if (user.name == username) {
									found = true;
								}
								ulUsers.appendChild(liUser);
							}
							liTable.innerText = table;
							liTable.appendChild(ulUsers);
							ulTables.appendChild(liTable);
						}
					});

			const connectedUser = (username) => {
				const joinButton = document.getElementById('join_button');
				if (!joinButton) {
					console.log('join_button button not found');
					return;
				}
				const joinButtonInput = /** @type {HTMLInputElement} */ (joinButton);
				joinButtonInput.disabled = true;

				const connectedDiv = document.getElementById('connected');
				if (!connectedDiv) {
					console.log('connected element not found');
					return;
				}
				connectedDiv.innerHTML = '';

				const finishedButton = document.createElement('button');
				finishedButton.innerHTML = 'Game finished (return to Panama)!';
				finishedButton.addEventListener('click', function (event) {
					fetch('/me/finish?username=' + encodeURIComponent(username)).then(() => {
						console.log('User finished:', username);
						// refreshTables();
					});
				});

				const quitButton = document.createElement('button');
				quitButton.innerHTML = 'Quit Meltdown (' + username + ')';
				quitButton.addEventListener('click', function (event) {
					fetch('/me/quit?username=' + encodeURIComponent(username)).then(() => {
						console.log('User left:', username);
						localStorage.removeItem('username');
						connectedDiv.innerHTML = '';
						joinButtonInput.disabled = false;
						// refreshTables();
					});
				});

				connectedDiv.appendChild(quitButton);
				connectedDiv.appendChild(document.createElement('br'));
				connectedDiv.appendChild(finishedButton);
			};

			(function () {
				const username = localStorage.getItem('username');
				if (username) {
					console.log(`user already set: ${username}`);
					const usernameElem = document.getElementById('username');
					if (!usernameElem) {
						console.log('username element not found');
						return;
					}
					const usernameInput = /** @type {HTMLInputElement} */ (usernameElem);
					usernameInput.value = username;
					connectedUser(username);
					connectWebsocket(username);
				}

				const joinForm = document.getElementById('join');
				if (!joinForm) {
					console.log('join element not found');
					return;
				}
				joinForm.addEventListener('submit', function (event) {
					event.preventDefault();
					const usernameElem = document.getElementById('username');
					if (!usernameElem) {
						console.log('username element not found');
						return;
					}
					const usernameInput = /** @type {HTMLInputElement} */ (usernameElem);
					const username = usernameInput.value;

					fetch('/me/join?username=' + encodeURIComponent(username))
						.then((resp) => resp.text())
						.then((text) => {
							localStorage.setItem('username', username);
							connectedUser(username);
							// refreshTables();
						});
				});
			})();
		</script>
	</body>
</html>
